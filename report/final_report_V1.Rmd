---
title: "W271 Group Lab 2 Team 2"
author: "Katt Painter, Bo He, Akanksha Chattopadhyay, Ian Vaimberg"
output: 'pdf_document'  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(patchwork)

library(lubridate)

library(tsibble)
library(feasts)
library(forecast)

library(sandwich)
library(lmtest)

library(nycflights13)
library(blsR)

library(Matrix) 
library(data.table) 
library(stats)
library(fable)
library(tseries)
library(reprex)
library(stargazer)
```

\centerline{\textit{POV: 1997}}

## Context 

Climate science has emerged as a leading field of interest in the 20th century. Efforts to bring awareness to the impact of human intervention on the environment, such as the burning of fossil fuels, have proved fruitful. The Intergovernmental Panel on Climate Change (IPCC) has reinforced these efforts. In 1990 they released the First Climate Assessment Report stating that "human activities are substantially increasing the atmospheric concentration of greenhouse gases" (IPCC, 1990). Greenhouse gases are a group of gases, such as carbon dioxide, methane, and nitrous oxide, that when present in higher concentrations in the atmosphere, raise the surface temperate of the Earth. Carbon dioxide is the most abundant greenhouse gas that is produced from human activity, namely energy production via fossil fuel combustion. Since the industrial revolution, energy consumption from petroleum and natural gas sources has risen dramatically. This report aims to investigate the following questions: How have the levels of atmospheric CO2 changed over time? And, is there an identifiable pattern that will persist into the future? Forecasting atmospheric carbon dioxide concentrations allows scientists to measure the corresponding impact to the global environment and justify the need for human intervention in the opposite direction. 

## Data and Exploration 

```{r load and format data, echo=FALSE}
data <- datasets::co2

data <- data %>% 
  as_tsibble(data) %>% 
  mutate(month = as.factor(month(index)))
```

Charles Keeling was a research scientist who made it his life's work to survey the atmosphere in hopes of confirming Svante Arrhenius's theory that fossil fuel combustion is increasing the concentration of CO2 in the atmosphere. To this end, Keeling collected atmospheric CO2 concentration measurements at a number of sampling-stations including the Mauna Loa Observatory in Hawaii. These measurements were taken using a CO2 analyzer which detects the amount of infrared absorption present in a air sample and turns it into a mole fraction of CO2, defined as the total CO2 molecules divided by the total non-water vapor molecules in the air, measured in parts per million (ppm). This report uses the data collected at the Mauna Loa Observatory between January 1959 and December 1997. The dataset consists of 468 observations with each observation representing the monthly total atmospheric concentration of CO2 (ppm). The observations for February, March, and April 1964 were unavailable so the values in the dataset were generated via linear interpolation between the observations for January and May 1964. 

In order to better understand the characteristics of this time series, we conducted a exploratory analysis prior to modeling. Figure 1 shows the time series plot for CO2 concentration, its autocorrelation plot, and its partial autocorrelation plot. The time series plot shows a clear positive trend as well as the presence of seasonality. The autocorrelation plot provides evidence to support the presence of both trend and seasonality as it decays with increasing lags and shows a spike at about every twelfth lag, indicating a seasonal cycle. 

- Discuss seasonal/trend decomposition 
- What about growth rates?
  - Some acceleration to the growth rates 
  - Growth rate is mean reverting with given process 

```{r time series plot, echo=FALSE, fig.width = 10, fig.height = 3}
time_series <- ggplot(data, aes(x=index, y=value)) +
  geom_line() +
  ylab("CO2 Concentration") +
  xlab("Time") +
  ggtitle("CO2 Concentration 1959 - 1997")

acf <- ggAcf(data$value, lag.max = 50) +
  ggtitle("ACF")

pacf <- ggPacf(data$value, lag.max = 50) +
  ggtitle("Partial ACF")

time_series + acf + pacf + plot_annotation(expression(italic('Figure 1. Time Series, ACF, and PACF')), theme=theme(plot.title=element_text(hjust=0.5)))
```

## Models and Forecasts

While the exploratory analysis allows us to infer the underlying process of the time series, we cannot confirm this process without empirical modeling. In this section we will produce multiple models from the following classes, linear models and ARIMA models. Following the modeling and model evaluation, we will use the models to produce forecasts for what the CO2 concentration will be over the next 20 years. 

### *Linear Models*

Three linear models were considered, these models are describe by the following set of equations: 
\begin{align}
y_t=t+\epsilon_t
\end{align}
\begin{align}
y_t=t+t^2+\epsilon_t
\end{align}
\begin{align}
y_t=t+d_{2, t}+d_{3, t}+...+d_{11, t}+d_{12, t}+\epsilon_t
\end{align}
where $t$ is the time index (i.e., year-month) represented as an integer and $d$ is a dummy variable representing each month. For example $d_{2}$ would correspond to the month of February, $d_{3}$ would correspond to the month of March, and so on. 

The following table reports the coefficients that produce the best fit for each of the previously defined models. It also reports several performance metrics such as R-squared, adjusted R-squared, F statistics, etc. The table suggests that each model explains a large amount of the variation in CO2 emissions with adjusted R-squared values ranging from 0.97 to 0.99. This indicates that these models appear to perform extremely well. The p-values associated with each predictor are also significant, indicating that each predictor increases the explanatory power of the model. However, in order to determine the appropriateness of using linear models to estimate CO2 concentrations we must examine the residuals of each model. 

```{r  linear models, echo = FALSE, results='hide'}
data$month_since_start <- as.numeric(index(data) - min(index(data))) + 1

lm_model <- lm(value ~ month_since_start, data=data)

quad_model <- lm(value ~ month_since_start + I(month_since_start^2), data=data)

lm_seasonal_model <- lm(value ~ month_since_start  + I(month_since_start^2) + month, data=data)
```

```{r stargazer linear models, results = "asis", fig.width = 10, fig.height = 3, echo=FALSE, fig.pos="H"}
star <- stargazer(
    lm_model, quad_model, lm_seasonal_model,
    type = "latex",
    title = "Estimated Linear Models",
    dep.var.caption  = "Response: Atmospheric CO2 Concentration",
    dep.var.labels   = "",
    header=FALSE,
    star.cutoffs = c(0.05, 0.01, 0.001),
    digits=2,
    no.space = TRUE, 
    column.sep.width = "1pt", 
    single.row = TRUE,
    covariate.labels = c(
        "Month Index",
        "Month Index$^{2}$",
        "Feb",
        "March",
        "April",
        "May",
        "June",
        "July",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec"
    ),
    font.size = "small"
)
```

Figure 2 shows the standardized residuals against the fitted values for each linear model. There are clear patterns present in each of these plots. The first model shows a U-shaped curve that indicates the model is under predicting CO2 concentrations that are in the mid-range and over predicting CO2 concentrations closer to the edges. Whereas the quadratic model appears to oscillate in whether it is over or under predicting CO2 concentrations. The polynomial model appears to also have a U-shaped pattern. However, compared to the first model, its errors appear to be larger, especially at edge values. Nevertheless, the residuals appear to be homoskedastic for all three models which suggests that no transformation (i.e., logarthmic) is needed. Overall, these plots suggest that linear models are not appropriate for this particular data set. They do not appear to adequately capture the underlying time series process. So we must turn to ARIMA models.   

```{r residual plots linear models, echo = FALSE, fig.width = 10, fig.height = 3}
lm_residual_data <- data.frame(
  predicted_values = fitted(lm_model),
  residuals = rstandard(lm_model)
)

quad_residual_data <- data.frame(
  predicted_values = fitted(quad_model),
  residuals = rstandard(quad_model)
)

poly_residual_data <- data.frame(
  predicted_values = fitted(lm_seasonal_model),
  residuals = rstandard(lm_seasonal_model)
)

lm_resid_plot <- ggplot(lm_residual_data, aes(x = predicted_values, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(se = FALSE, formula = y ~ x, method = "loess") +
  labs(title = "Linear Model (1)", y = "Standardized Residuals", x = "Fitted Values")

quad_resid_plot <- ggplot(quad_residual_data, aes(x = predicted_values, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(se = FALSE, formula = y ~ x, method = "loess") +
  labs(title = "Quadratic Model (2)", y = "", x = "Fitted Values")

poly_resid_plot <- ggplot(poly_residual_data, aes(x = predicted_values, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(se = FALSE, formula = y ~ x, method = "loess") +
  labs(title = "Polynomial Model (3)", 
       x = "Fitted Values", y = "")

(lm_resid_plot | quad_resid_plot | poly_resid_plot) + plot_annotation(expression(italic('Figure 2. Linear Model Evaluation')), theme=theme(plot.title=element_text(hjust=0.5)))
```

### *ARIMA Models*

- Functional form 
- Differencing required 

```{r ARIMA Modeling, echo = FALSE}
# model_ma.bic<-data %>%
# model(ARIMA(value ~ 1 + pdq(0,0:1,0:3) + PDQ(0,0:1,0:3), ic="bic", stepwise=F, greedy=F,
#             order_constraint = p + q + P + Q <= 10))
# 
# model_ar.bic<-data %>%
# model(ARIMA(value ~ 1 + pdq(0:3,0:1,0) + PDQ(0:3,0:1,0), ic="bic", stepwise=F, greedy=F,
#             order_constraint = p + q + P + Q <= 10))
# 
# model_full.bic<-data %>%
# model(ARIMA(value ~ 1 + pdq(0:3,0:1,0:3) + PDQ(0:3,0:1,0:3), ic="bic", stepwise=F, greedy=F,
#             order_constraint = p + q + P + Q <= 10))
# 
# # Report model summaries 
# model_ma.bic %>% # Best BIC model to use for forecasting 
# report()
# 
# model_ar.bic %>%
# report()
# 
# model_full.bic %>%
# report()
```

- Functional form 
- Results 

### *Forecasts*

```{r polynomial forecasts, echo = FALSE, results = 'hide'}
# index <- seq(from = ymd("1998-01-01"), to = ymd("2020-12-01"), by = "1 month")
# 
# ext_data <- data.frame(index = index) %>% 
#   as_tsibble(index=index) %>% 
#   mutate(month = as.factor(month(index))) 
# 
# ext_data$month_since_start <- seq(max(data$month_since_start)+1,max(data$month_since_start)+(23*12))
# 
# forecast <- data.frame(predict = predict(lm_seasonal_model, newdata = ext_data))
# 
# forecast$index <- ext_data$index
# 
# ggplot(forecast, aes(x=index, y=predict)) +
#   geom_line() +
#   ylab("CO2 Concentration") +
#   xlab("Year-Month") +
#   ggtitle("CO2 Concentration Forecast 1998 - 2020")
```

```{r ARIMA forcast 2022, echo=FALSE}
# model_ma.forecasts<-forecast(model_ma.bic, h=25*12)
# 
# autoplot(model_ma.forecasts) +
#   autolayer(data, colour = "black", .vars = value) +
#   xlab("Year") +
#   ylab("Value") +
#   ggtitle("ARIMA Forecast for Next 25 Years")
```

- Forecasts 
- Predictions for when CO2 is expected to be at 420 ppm and 500 ppm 
- Interpretation/evaluation? 

## Conclusions 

- Implications 



